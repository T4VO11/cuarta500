<div class="container mt-4">

  <button class="btn btn-secondary mb-4" [routerLink]="['/main/usuarios']">
      <i class="bi bi-arrow-left"></i> Regresar a Lista de Usuarios
  </button>
  
  <div *ngIf="isLoading" class="alert alert-info">Cargando datos del usuario...</div>
  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

  <div *ngIf="usuarioAEditar" class="card p-4 mb-4 shadow-lg">
    <h3 class="card-title mb-4 border-bottom pb-2">
      Editando Usuario: {{ usuarioAEditar.nombre }} {{ usuarioAEditar.apellido_paterno }}
    </h3>
    
    <form (ngSubmit)="submitUsuarioForm()" #usuarioForm="ngForm"> 
      
      <div class="row mb-3">
        <div class="col-md-3">
          <label>ID Interno (BD)</label>
          <input type="text" class="form-control" [ngModel]="usuarioAEditar._id" name="_id" disabled>
        </div>
        <div class="col-md-3">
          <label>Usuario ID (usuario_id)</label>
          <input type="number" class="form-control" [(ngModel)]="usuarioAEditar.usuario_id" name="usuario_id" required>
        </div>
        <div class="col-md-3">
          <label>Username</label>
          <input type="text" class="form-control" [(ngModel)]="usuarioAEditar.username" name="username" required>
        </div>
        <div class="col-md-3">
          <label>Contraseña (Dejar vacío para NO cambiar)</label>
          <input type="password" class="form-control" [(ngModel)]="usuarioAEditar.password" name="password">
        </div>
        <div class="col-md-3">
          <label>Rol</label>
          <select class="form-control" [(ngModel)]="usuarioAEditar.rol" name="rol" required>
            <option value="administrador">Administrador</option>
            <option value="guardia">Guardia</option>
            <option value="dueño">Dueño</option>
            <option value="habitante">Habitante</option>
            <option value="arrendatario">Arrendatario</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4"><label>Nombre</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.nombre" name="nombre" required></div>
        <div class="col-md-4"><label>Apellido Paterno</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.apellido_paterno" name="apellido_paterno" required></div>
        <div class="col-md-4"><label>Apellido Materno</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.apellido_materno" name="apellido_materno" required></div>
      </div>

      <div class="row mb-3">
          <div class="col-md-4"><label>Email</label><input type="email" class="form-control" [(ngModel)]="usuarioAEditar.email" name="email" required></div>
          <div class="col-md-4"><label>Teléfono</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.telefono" name="telefono" required></div>
          <div class="col-md-4"><label>No. Casa</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.numero_casa" name="numero_casa"></div>
      </div>
      
      <div class="row border-top pt-3 mb-3">
          <h5 class="col-12 mb-3">Detalles Adicionales</h5>
          <div class="col-md-3"><label>RFC</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.perfil_detalle.rfc" name="rfc"></div>
          <div class="col-md-3"><label>NSS</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.perfil_detalle.nss" name="nss"></div>
          <div class="col-md-3"><label>Modelo Auto</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.perfil_detalle.auto.modelo" name="modelo"></div>
          <div class="col-md-3"><label>Color Auto</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.perfil_detalle.auto.color" name="color"></div>
          <div class="col-md-3"><label>Placas Auto</label><input type="text" class="form-control" [(ngModel)]="usuarioAEditar.perfil_detalle.auto.placas" name="placas"></div>
      </div>


      <div class="row border-top pt-3 mb-3">
        <h5 class="col-12 mb-3">Gestión de Documentos (Sube uno nuevo solo si deseas reemplazar el actual)</h5>
        
        <div class="col-md-6">
          <label for="imagen_perfil" class="form-label">Imagen de Perfil</label>
          <input type="file" (change)="onFileSelected($event, 'perfil')" accept="image/*" class="form-control">
          <small class="text-secondary" *ngIf="usuarioAEditar.documentos?.imagen_perfil_url">
            Imagen actual: <a [href]="usuarioAEditar.documentos.imagen_perfil_url" target="_blank">Ver Imagen</a>
          </small>
        </div>
        
        <div class="col-md-6">
          <label for="imagen_ine" class="form-label">Imagen INE</label>
          <input type="file" (change)="onFileSelected($event, 'ine')" accept="image/*" class="form-control">
          <small class="text-secondary" *ngIf="usuarioAEditar.documentos?.imagen_ine_url">
            Imagen actual: <a [href]="usuarioAEditar.documentos.imagen_ine_url" target="_blank">Ver INE</a>
          </small>
        </div>
      </div>
      
      <div class="row border-top pt-3">
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-warning" [disabled]="!usuarioForm.valid">
            <i class="bi bi-pencil-square"></i> Guardar Cambios
          </button>
        </div>
      </div>
    </form>
  </div>
</div>